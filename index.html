<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Chat Hub</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, getDocs, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Expose Firebase dependencies globally for the React script block
        window.firebaseDependencies = {
            initializeApp, getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, updateProfile, getFirestore, doc, addDoc, 
            onSnapshot, collection, query, serverTimestamp, getDocs, setDoc, 
            deleteDoc, updateDoc
        };
    </script>
    <!-- Custom styling for scrollbar and font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Style the scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-500">
    <div id="root">
        <!-- React component will mount here -->
    </div>

    <!-- The React application code goes here -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;
        
        // Destructure dependencies loaded via the module script block
        const { 
            initializeApp, getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, updateProfile, getFirestore, doc, addDoc, 
            onSnapshot, collection, query, serverTimestamp, getDocs, setDoc, 
            deleteDoc, updateDoc
        } = window.firebaseDependencies;

        // --- Environment Variables (Your Config) ---
        // NOTE: The Firebase configuration below must be replaced with your actual values if you want to deploy it to a new Firebase project.
        const appId = 'cutechat-f515a'; 
        const firebaseConfig = {
          apiKey: "AIzaSyAfIpg0xMFsghQZth0VN3bS479dBsQEywo",
          authDomain: "cutechat-f515a.firebaseapp.com",
          projectId: "cutechat-f515a",
          storageBucket: "cutechat-f515a.firebasestorage.app",
          messagingSenderId: "418193295339",
          appId: "1:418193295339:web:ecfdfe5f2844ec131a3bae",
          measurementId: "G-H4PCRGZP1R"
        };
        const initialAuthToken = null; 

        // --- Utility Icons (Lucide) ---
        const SendIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>);
        const LogOutIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>);
        const UserIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>);
        const HashIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>);
        const MessageSquareIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>);
        const CrownIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3l3 4H9l3-4zM5 7h14l-2 5h-10L5 7zM17 12l-2 9H9l-2-9h10z"></path></svg>);
        const ShieldIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>);
        const TrashIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>);
        const SettingsIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1.51-1V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09z"></path></svg>);

        // --- Main Application Component ---
        const App = () => {
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [user, setUser] = useState(null);
          const [loading, setLoading] = useState(true);
          const [authError, setAuthError] = useState(null);
          const [dataError, setDataError] = useState(null);
          
          // Role and User Management State
          const [userRoles, setUserRoles] = useState({}); 
          const currentUserRole = userRoles[user?.uid] || { role: 'user', isBanned: false };
          const isOwner = currentUserRole.role === 'owner';
          const isMod = currentUserRole.role === 'mod' || isOwner;
          const isBanned = currentUserRole.isBanned; // <-- Available via closure to ChatContent

          // Chat/Navigation State
          const [activeTab, setActiveTab] = useState('public'); 
          const [activeChatRecipient, setActiveChatRecipient] = useState(null); 
          
          // --- 1. Firebase Initialization & Auth ---
          useEffect(() => {
            if (!firebaseConfig || !Object.keys(firebaseConfig).length) {
              setDataError("Firebase configuration is missing.");
              setLoading(false);
              return;
            }

            try {
              const app = initializeApp(firebaseConfig);
              const firestore = getFirestore(app);
              const authentication = getAuth(app);

              setDb(firestore);
              setAuth(authentication);

              const unsubscribe = onAuthStateChanged(authentication, (currentUser) => {
                setUser(currentUser);
                setLoading(false);
                setAuthError(null);
              });

              return () => unsubscribe();
            } catch (e) {
              console.error("Initialization error:", e);
              setDataError("Failed to initialize Firebase services.");
              setLoading(false);
            }
          }, []);

          // --- 2. Real-Time User Roles/List Listener ---
          useEffect(() => {
            if (!db || !user) {
                setUserRoles({});
                return;
            }

            const rolesCollectionPath = `/artifacts/${appId}/public/data/user_roles`;
            const q = collection(db, rolesCollectionPath);

            const unsubscribe = onSnapshot(q, async (snapshot) => {
                const roles = {};
                let currentUserFound = false;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    roles[doc.id] = { ...data, uid: doc.id };
                    if (doc.id === user.uid) currentUserFound = true;
                });

                // Owner/Initial Setup Logic (Only run if the current user is not in roles)
                if (user && !currentUserFound) {
                    console.log("Current user role not found. Checking for initial setup.");
                    
                    // Check if ANY roles exist
                    const allDocs = await getDocs(q);
                    if (allDocs.empty) {
                        // If the collection is empty, make this user the owner
                        const ownerRef = doc(db, rolesCollectionPath, user.uid);
                        await setDoc(ownerRef, {
                            username: user.displayName || user.email,
                            role: 'owner', // The first user is the Owner
                            isBanned: false,
                        });
                        console.log("First user detected and set as Owner.");
                    } else {
                         // Otherwise, assign them the default 'user' role
                         const userRef = doc(db, rolesCollectionPath, user.uid);
                         await setDoc(userRef, {
                            username: user.displayName || user.email,
                            role: 'user',
                            isBanned: false,
                        });
                    }
                }
                setUserRoles(roles);
            }, (err) => {
                console.error("Role Snapshot Error:", err);
                setDataError("Failed to load user roles.");
            });

            return () => unsubscribe();
          }, [db, user]);

          // --- 3. Authentication Handlers ---
          const handleSignOut = useCallback(async () => {
            if (!auth) return;
            try {
              await signOut(auth);
            } catch (e) {
              console.error("Sign Out Error:", e);
              setAuthError("Failed to sign out.");
            }
          }, [auth]);

          // --- 4. Role Management Handlers (Owner Only) ---
          const getRoleRef = (uid) => doc(db, `/artifacts/${appId}/public/data/user_roles/${uid}`);

          const toggleBanUser = useCallback(async (targetUid, isCurrentlyBanned) => {
            if (!isOwner || !db || targetUid === user.uid) return; 

            try {
                await updateDoc(getRoleRef(targetUid), { isBanned: !isCurrentlyBanned });
            } catch (e) {
                console.error("Error toggling ban:", e);
                setDataError("Failed to toggle ban status.");
            }
          }, [isOwner, db, user]);

          const toggleModRole = useCallback(async (targetUid, currentRole) => {
            if (!isOwner || !db || targetUid === user.uid) return; 

            try {
                const newRole = currentRole === 'mod' ? 'user' : 'mod';
                await updateDoc(getRoleRef(targetUid), { role: newRole });
            } catch (e) {
                console.error("Error toggling mod role:", e);
                setDataError("Failed to toggle moderator role.");
            }
          }, [isOwner, db, user]);
          
          // --- COMPONENTS ---

          const AuthForm = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [username, setUsername] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [formLoading, setFormLoading] = useState(false);
            const [formError, setFormError] = useState(null);

            const handleAuthAction = async (e) => {
              e.preventDefault();
              setFormLoading(true);
              setFormError(null);

              try {
                if (isRegistering) {
                  if (!username.trim()) throw new Error("Username is required.");
                  const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                  await updateProfile(userCredential.user, { displayName: username.trim() });
                } else {
                  await signInWithEmailAndPassword(auth, email, password);
                }
              } catch (error) {
                console.error("Auth Error:", error.message);
                const cleanMessage = error.message.replace('Firebase: ', '').replace(/\(.*\)/, '');
                setFormError(cleanMessage);
              } finally {
                setFormLoading(false);
              }
            };

            return (
              <div className="max-w-sm mx-auto p-6 sm:p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl transition-all duration-300">
                <h2 className="text-3xl font-bold text-center mb-6 text-indigo-600 dark:text-indigo-400">
                  {isRegistering ? 'Create Account' : 'Sign In'}
                </h2>
                {formError && (
                  <div className="p-3 mb-4 text-sm font-medium text-red-700 bg-red-100 rounded-lg dark:bg-red-800 dark:text-red-300">{formError}</div>
                )}
                <form onSubmit={handleAuthAction} className="space-y-4">
                  {isRegistering && (
                    <div>
                      <input type="text" placeholder="Username" required value={username} onChange={(e) => setUsername(e.target.value)}
                        className="w-full pl-3 pr-3 py-3 border rounded-xl focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" disabled={formLoading} />
                    </div>
                  )}
                  <input type="email" placeholder="Email" required value={email} onChange={(e) => setEmail(e.target.value)}
                    className="w-full pl-3 pr-3 py-3 border rounded-xl focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" disabled={formLoading} />
                  <input type="password" placeholder="Password (6+ chars)" required value={password} onChange={(e) => setPassword(e.target.value)}
                    className="w-full pl-3 pr-3 py-3 border rounded-xl focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" disabled={formLoading} />
                  <button type="submit" className="w-full py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-200 shadow-md disabled:opacity-50" disabled={formLoading}>
                    {formLoading ? 'Processing...' : isRegistering ? 'Sign Up' : 'Sign In'}
                  </button>
                </form>
                <div className="mt-6 text-center">
                  <button onClick={() => { setIsRegistering(prev => !prev); setFormError(null); }}
                    className="text-sm text-indigo-500 hover:text-indigo-600 dark:text-indigo-400 dark:hover:text-indigo-300 transition-colors" disabled={formLoading}>
                    {isRegistering ? 'Already have an account? Sign In' : "Don't have an account? Sign Up"}
                  </button>
                </div>
              </div>
            );
          };
          
          const ChatSidebar = () => {
            const sortedUsers = useMemo(() => {
                return Object.values(userRoles)
                    .filter(u => u.uid !== user.uid && u.username)
                    .sort((a, b) => a.username.localeCompare(b.username));
            }, [userRoles, user]);

            const usersForPm = sortedUsers.map(u => ({ uid: u.uid, username: u.username }));

            const getTabClasses = (tab) => 
              `flex items-center w-full p-3 mb-2 rounded-xl transition duration-150 ${activeTab === tab 
                ? 'bg-indigo-600 text-white shadow-lg' 
                : 'text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700'}`;
            
            const getRecipientClasses = (recipient) => 
                `flex items-center w-full p-2 rounded-lg transition duration-150 text-left ${activeChatRecipient?.uid === recipient.uid
                    ? 'bg-indigo-200 dark:bg-indigo-700 text-indigo-800 dark:text-white font-semibold'
                    : 'hover:bg-gray-200 dark:hover:bg-gray-700'}`;

            return (
              <div className="w-full sm:w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 p-4 flex flex-col h-full overflow-y-auto">
                {/* Main Tabs */}
                <nav className="mb-6 border-b pb-4 border-gray-200 dark:border-gray-700">
                  <button onClick={() => { setActiveTab('public'); setActiveChatRecipient(null); }} className={getTabClasses('public')}>
                    <HashIcon className="mr-3" /> Public Chat
                  </button>
                  <button onClick={() => setActiveTab('private')} className={getTabClasses('private')}>
                    <MessageSquareIcon className="mr-3" /> Private Messages
                  </button>
                  {isOwner && (
                    <button onClick={() => { setActiveTab('admin'); setActiveChatRecipient(null); }} className={getTabClasses('admin')}>
                      <SettingsIcon className="mr-3" /> Admin Panel
                    </button>
                  )}
                </nav>
                
                {/* Private Message List */}
                {activeTab === 'private' && (
                    <div className='flex-1'>
                        <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-3">Users</h3>
                        <div className='space-y-1'>
                            {usersForPm.length === 0 && <p className='text-sm text-gray-500'>No other users online.</p>}
                            {usersForPm.map(recipient => (
                                <button key={recipient.uid} onClick={() => setActiveChatRecipient(recipient)} className={getRecipientClasses(recipient)}>
                                   <UserIcon className="mr-2 w-4 h-4" /> {recipient.username}
                                </button>
                            ))}
                        </div>
                    </div>
                )}
              </div>
            );
          };

          const AdminPanel = () => {
            // Only includes users who are NOT the current owner
            const managedUsers = useMemo(() => {
                return Object.values(userRoles)
                    .filter(u => u.uid !== user.uid)
                    .sort((a, b) => a.username.localeCompare(b.username));
            }, [userRoles, user]);

            return (
                <div className="p-4 sm:p-8 w-full overflow-y-auto">
                    <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-6">User Management</h2>
                    <div className="space-y-4">
                        {managedUsers.map(u => (
                            <div key={u.uid} className={`flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 rounded-xl shadow-lg transition-all duration-300 ${u.isBanned ? 'bg-red-100 dark:bg-red-900/50' : u.role === 'mod' ? 'bg-yellow-50 dark:bg-yellow-900/50' : 'bg-white dark:bg-gray-700/80'}`}>
                                <div className="mb-2 sm:mb-0">
                                    <p className="text-lg font-semibold text-gray-900 dark:text-white">{u.username}</p>
                                    <div className="flex items-center space-x-2 mt-1">
                                        {u.role === 'owner' && <span className="flex items-center text-indigo-600 dark:text-indigo-400 text-sm font-medium"><CrownIcon className="inline-block w-4 h-4 mr-1" /> OWNER</span>}
                                        {u.role === 'mod' && <span className="flex items-center text-yellow-600 dark:text-yellow-400 text-sm font-medium"><ShieldIcon className="inline-block w-4 h-4 mr-1" /> MODERATOR</span>}
                                        {u.isBanned && <span className="text-red-600 dark:text-red-400 text-sm font-medium">(BANNED)</span>}
                                        {u.role === 'user' && !u.isBanned && <span className="text-gray-500 text-sm font-medium">Standard User</span>}
                                    </div>
                                </div>
                                <div className="flex flex-wrap space-x-2 pt-2 sm:pt-0">
                                    {/* Ban/Unban Button */}
                                    <button 
                                        onClick={() => toggleBanUser(u.uid, u.isBanned)}
                                        className={`px-4 py-2 text-sm font-semibold rounded-lg shadow-md transition-colors ${u.isBanned ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-red-500 hover:bg-red-600 text-white'}`}
                                        >
                                        {u.isBanned ? 'Unban User' : 'Ban User'}
                                    </button>
                                    {/* Mod/Unmod Button */}
                                    <button
                                        onClick={() => toggleModRole(u.uid, u.role)}
                                        className={`px-4 py-2 text-sm font-semibold rounded-lg shadow-md transition-colors ${u.role === 'mod' ? 'bg-gray-300 hover:bg-gray-400 text-gray-800' : 'bg-blue-500 hover:bg-blue-600 text-white'}`}
                                        >
                                        {u.role === 'mod' ? 'Remove Mod' : 'Make Moderator'}
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
          };

          const ChatContent = ({ chatType, recipient }) => {
            const [messages, setMessages] = useState([]);
            const [newMessageText, setNewMessageText] = useState('');
            const [chatLoading, setChatLoading] = useState(true);
            const chatMessagesRef = useRef(null);
            
            // Accessing isBanned from the parent App component's closure
            const isSenderBanned = isBanned; 

            // Determines the Firestore collection path
            const chatPath = useMemo(() => {
                if (chatType === 'public') {
                    return `/artifacts/${appId}/public/data/public_chat_messages`;
                }
                if (chatType === 'private' && recipient) {
                    // Create a consistent chatId by sorting the two UIDs
                    const uids = [user.uid, recipient.uid].sort();
                    const chatId = uids.join('_');
                    return `/artifacts/${appId}/public/data/private_chats/${chatId}/messages`;
                }
                return null;
            }, [chatType, recipient, user]);

            // Firestore Listener (Public/Private)
            useEffect(() => {
                if (!db || !chatPath) return setMessages([]);

                const messagesCollectionRef = collection(db, chatPath);
                const q = query(messagesCollectionRef);

                setChatLoading(true);

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedMessages = [];
                    snapshot.forEach((doc) => {
                        fetchedMessages.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Sort by creation time (oldest first for chat display)
                    fetchedMessages.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                    
                    setMessages(fetchedMessages);
                    setChatLoading(false);
                }, (err) => {
                    console.error("Chat Snapshot Error:", err);
                    setDataError(`Failed to load ${chatType} chat.`);
                    setChatLoading(false);
                });

                return () => unsubscribe();
            }, [db, chatPath, chatType]);

            // Auto-scroll
            useEffect(() => {
                if (chatMessagesRef.current) {
                    chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight;
                }
            }, [messages]);

            // Send Message Handler (FIXED/VERIFIED)
            const handleSendMessage = useCallback(async () => {
                const messageText = newMessageText.trim();
                
                if (!db || !user || messageText === '' || isSenderBanned) {
                    console.warn("Attempted to send empty/banned message. Aborting.");
                    return; 
                }

                try {
                    const messagesCollectionRef = collection(db, chatPath);

                    await addDoc(messagesCollectionRef, {
                        text: messageText,
                        uid: user.uid,
                        username: user.displayName || user.email,
                        createdAt: serverTimestamp(),
                    });
                    setNewMessageText(''); // Clear the input on successful send
                } catch (e) {
                    console.error("Error sending message: ", e);
                    setDataError("Failed to send message.");
                }
            }, [db, user, newMessageText, chatPath, isSenderBanned]);

            const deleteMessage = useCallback(async (messageId) => {
                if (!db || !isMod) return; 

                try {
                    const messageRef = doc(db, chatPath, messageId);
                    await deleteDoc(messageRef);
                } catch (e) {
                    console.error("Error deleting message:", e);
                    setDataError("Failed to delete message.");
                }
            }, [db, isMod, chatPath]);

            if (chatType === 'private' && !recipient) {
                return (
                    <div className="flex-1 flex justify-center items-center">
                        <p className="text-xl text-gray-500 dark:text-gray-400">Select a user from the left to start a private chat.</p>
                    </div>
                );
            }
            
            // Message Item Sub-Component
            const MessageItem = ({ message }) => {
                const sender = userRoles[message.uid] || { username: message.username, role: 'user', isBanned: false };
                const isCurrentUser = user && user.uid === message.uid;
                // Safely format timestamp
                const time = message.createdAt?.toDate ? message.createdAt.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...';

                return (
                    <div className={`flex mb-4 ${isCurrentUser ? 'justify-end' : 'justify-start'}`}>
                        <div className={`flex items-start max-w-xs sm:max-w-md lg:max-w-lg ${isCurrentUser ? 'flex-row-reverse' : 'flex-row'} space-x-2 ${!isCurrentUser ? 'sm:space-x-reverse' : ''}`}>
                            <div className={`p-3 rounded-xl shadow-lg transition-all ${isCurrentUser 
                                ? 'bg-indigo-600 text-white rounded-br-none' 
                                : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-tl-none'}`}>
                                <div className="flex justify-between items-baseline mb-1">
                                    <span className={`text-sm font-bold ${isCurrentUser ? 'text-indigo-200' : 'text-indigo-600 dark:text-indigo-400'}`}>
                                        {isCurrentUser ? 'You' : sender.username}
                                        {sender.role === 'owner' && <CrownIcon className="inline-block w-4 h-4 ml-1 align-top" />}
                                        {sender.role === 'mod' && <ShieldIcon className="inline-block w-4 h-4 ml-1 align-top" />}
                                    </span>
                                    <span className="text-xs ml-4" style={{ color: isCurrentUser ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.4)' }}>
                                        {time}
                                    </span>
                                </div>
                                <p className="text-base break-words whitespace-pre-wrap">{message.text}</p>
                            </div>
                            
                            {/* Delete button (Owner/Mod only in public chat, Sender only in private chat) */}
                            {(isMod && chatType === 'public') || (isCurrentUser && chatType === 'private') ? (
                                <button 
                                    onClick={() => deleteMessage(message.id)}
                                    className="p-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition-colors self-center"
                                    aria-label="Delete message"
                                >
                                    <TrashIcon className="w-4 h-4" />
                                </button>
                            ) : null}
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col w-full h-full bg-gray-50 dark:bg-gray-900">
                    {/* Chat Title */}
                    <div className="p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-10">
                        <h3 className="text-xl font-bold text-gray-900 dark:text-white">
                            {chatType === 'public' ? 'Global Chat' : `Private Chat with ${recipient.username}`}
                        </h3>
                    </div>
                    
                    {/* Messages Container */}
                    <main ref={chatMessagesRef} className="flex-1 overflow-y-auto p-4 space-y-4">
                        {chatLoading && messages.length === 0 && (
                            <p className="text-center text-indigo-500 dark:text-indigo-300">Loading messages...</p>
                        )}
                        
                        {messages.length === 0 && !chatLoading ? (
                            <div className="text-center p-10 mt-10">
                                <p className="text-xl text-gray-500 dark:text-gray-300">
                                    Say hello! Start the conversation. ðŸ‘‹
                                </p>
                            </div>
                        ) : (
                            messages.map((message) => (
                                <MessageItem key={message.id} message={message} />
                            ))
                        )}
                    </main>

                    {/* Message Input (FIXED: Ensure handleSendMessage is triggered) */}
                    <div className="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 sticky bottom-0 z-10 shadow-t-lg">
                        {isSenderBanned ? (
                            <div className="p-3 text-center bg-red-100 text-red-700 rounded-xl font-semibold dark:bg-red-900/50 dark:text-red-300">
                                You have been banned from sending messages.
                            </div>
                        ) : (
                            <div className="flex space-x-2">
                                <input
                                    type="text"
                                    value={newMessageText}
                                    onChange={(e) => setNewMessageText(e.target.value)}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter') {
                                            e.preventDefault(); // Prevent default form submission behavior
                                            handleSendMessage();
                                        }
                                    }}
                                    placeholder="Type your message..."
                                    className="flex-1 p-3 rounded-xl border-2 border-gray-300 focus:border-indigo-500 dark:border-gray-700 dark:bg-gray-700 dark:text-white transition duration-200"
                                    aria-label="New message input"
                                />
                                <button
                                    onClick={handleSendMessage}
                                    className="flex items-center justify-center p-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition duration-150 transform hover:scale-105 shadow-lg font-semibold disabled:opacity-50"
                                    disabled={newMessageText.trim() === ''}
                                    aria-label="Send Message"
                                >
                                    <SendIcon className="w-5 h-5" />
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
          };
          
          // --- Main Render Logic ---

          const renderContent = () => {
            if (activeTab === 'admin' && isOwner) {
                return <AdminPanel />;
            }
            
            if (activeTab === 'public') {
                return <ChatContent chatType="public" recipient={null} />;
            }

            if (activeTab === 'private') {
                return <ChatContent chatType="private" recipient={activeChatRecipient} />;
            }
            
            return null;
          };

          const Header = () => (
            <header className="p-4 border-b border-indigo-200 dark:border-indigo-700 flex justify-between items-center flex-wrap bg-white dark:bg-gray-800 shadow-md sticky top-0 z-20">
              <div className="flex items-center space-x-2">
                <h1 className="text-2xl font-extrabold text-indigo-700 dark:text-indigo-300">
                  Chat Hub
                </h1>
              </div>
              {user ? (
                <div className="flex items-center space-x-3 mt-2 sm:mt-0">
                  <div className="text-right">
                    <p className="font-bold text-gray-900 dark:text-white text-sm flex items-center justify-end">
                      {currentUserRole.role === 'owner' ? <CrownIcon className="w-4 h-4 text-indigo-500 mr-1" /> : currentUserRole.role === 'mod' ? <ShieldIcon className="w-4 h-4 text-yellow-500 mr-1" /> : <UserIcon className="w-4 h-4 text-gray-500 mr-1" />}
                      {user.displayName || user.email.split('@')[0]}
                    </p>
                  </div>
                  <button
                    onClick={handleSignOut}
                    className="flex items-center p-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 shadow-md"
                    aria-label="Sign Out"
                  >
                    <LogOutIcon className="w-4 h-4" />
                  </button>
                </div>
              ) : null}
            </header>
          );

          if (dataError) {
            return (
              <div className="flex items-center justify-center min-h-screen bg-red-100 dark:bg-red-900 p-4">
                <div className="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl text-center">
                  <h2 className="text-xl font-bold text-red-600 dark:text-red-400">Initialization Error</h2>
                  <p className="mt-4 text-gray-700 dark:text-gray-300">{dataError}</p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen font-[Inter] transition-colors duration-500 flex flex-col">
              <Header />

              {loading && !user ? (
                <div className="flex justify-center items-center flex-1">
                  <p className="text-indigo-600 dark:text-indigo-400 text-xl font-semibold">
                    Checking authentication status...
                  </p>
                </div>
              ) : !user ? (
                <div className="mt-16 p-4 flex-1">
                  <AuthForm />
                </div>
              ) : (
                // Authenticated User View (Sidebar + Content)
                <div className="flex flex-1 min-h-0" style={{ height: 'calc(100vh - 68px)' }}>
                  <ChatSidebar />
                  <div className="flex-1 overflow-hidden">
                      {renderContent()}
                  </div>
                </div>
              )}
            </div>
          );
        };

        // Mount the application
        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
